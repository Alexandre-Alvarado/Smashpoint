{% extends 'base.html' %}
{% block title %}Torneos - SmashPoint{% endblock %}
{% block content %}
<style>
.workflow-section {
    border-left: 3px solid #0d6efd;
    padding-left: 8px;
    margin-bottom: 8px;
}
.workflow-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 4px;
}
.action-btn-custom {
    min-width: 100px;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}
.progress-indicator {
    font-size: 0.75rem;
    color: #6c757d;
}
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
        <div>
                <h2 class="h4 mb-1">ğŸ† GestiÃ³n de Torneos</h2>
                <div class="text-muted small">Sigue el flujo: <strong>Inscripciones</strong> â†’ <strong>Grupos</strong> â†’ <strong>Bracket</strong> â†’ <strong>Finalizar</strong></div>
        </div>
        {% if es_admin %}
                <a href="{% url 'agregar_torneo' %}" class="btn btn-success">â• Nuevo Torneo</a>
        {% endif %}
</div>

<div class="alert alert-info alert-dismissible fade show" role="alert">
    <strong>ğŸ’¡ GuÃ­a rÃ¡pida:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>ğŸ‘¥ Inscripciones:</strong> Agrega jugadores al torneo</li>
        <li><strong>ğŸ“Š Grupos:</strong> Genera grupos (fase inicial todos contra todos)</li>
        <li><strong>ğŸ† Bracket:</strong> Crea eliminaciÃ³n directa con los clasificados</li>
        <li><strong>ğŸ¾ Partidos:</strong> Administra resultados y avanza rondas</li>
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-4">
        <input id="filtroNombre" type="text" class="form-control" placeholder="ğŸ” Buscar por nombre...">
    </div>
    <div class="col-md-4">
        <select id="filtroEstado" class="form-select">
            <option value="">ğŸ“‹ Todos los estados</option>
            <option value="ABIERTO">ğŸŸ¢ Abierto</option>
            <option value="EN_CURSO">ğŸŸ¡ En curso</option>
            <option value="FINALIZADO">âš« Finalizado</option>
        </select>
    </div>
    <div class="col-md-4 text-md-end">
        <small class="text-muted"><strong>Cupos:</strong> inscritos / mÃ¡ximo</small>
    </div>
</div>

<div class="table-responsive shadow-sm rounded">
    <table class="table align-middle mb-0 table-hover">
        <thead class="table-dark">
            <tr>
                <th style="width: 50px;">ID</th>
                <th>Nombre / CategorÃ­a</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th style="width: 100px;">Cupos</th>
                <th style="width: 450px;">Acciones del Torneo</th>
                {% if es_admin %}
                <th style="width: 100px;">Admin</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="torneosBody">
            {% for t in torneos %}
            <tr data-nombre="{{ t.nombre|lower }}" data-estado="{{ t.estado }}">
                <td class="text-muted fw-bold">{{ t.id }}</td>
                <td>
                    <div class="fw-bold">{{ t.nombre }}</div>
                    <small class="text-muted">ğŸ“ {{ t.direccion }}</small>
                    <br><span class="badge bg-secondary" style="font-size: 0.7rem;">{{ t.get_categoria_display }}</span>
                </td>
                <td>
                    <small class="text-nowrap">ğŸ“… {{ t.fecha|date:"d/m/Y" }}</small>
                </td>
                <td>
                    <span class="badge bg-{% if t.estado == 'FINALIZADO' %}secondary{% elif t.estado == 'EN_CURSO' %}warning text-dark{% else %}success{% endif %}" style="font-size: 0.85rem;">
                        {% if t.estado == 'FINALIZADO' %}âœ…{% elif t.estado == 'EN_CURSO' %}âš¡{% else %}ğŸŸ¢{% endif %} {{ t.get_estado_display }}
                    </span>
                </td>
                <td>
                    <span class="badge bg-{% if t.inscripciones_count >= t.cupos_max %}danger{% elif t.inscripciones_count > 0 %}info{% else %}secondary{% endif %}" style="font-size: 0.9rem;">
                        {{ t.inscripciones_count }} / {{ t.cupos_max }}
                    </span>
                </td>
                <td>
                    <div class="d-flex flex-column gap-2">
                        <!-- Paso 1: Inscripciones -->
                        <div class="workflow-section" style="border-color: #0d6efd;">
                            <div class="workflow-label">Paso 1: Inscripciones</div>
                            <a href="{% url 'lista_inscripciones' t.id %}" 
                               class="btn btn-sm btn-outline-info action-btn-custom" 
                               data-bs-toggle="tooltip" 
                               title="Agregar o ver jugadores inscritos en este torneo">
                                ğŸ‘¥ Inscripciones ({{ t.inscripciones_count }})
                            </a>
                        </div>
                        
                        <!-- Paso 2: Grupos -->
                        {% if t.numero_grupos > 0 %}
                        <div class="workflow-section" style="border-color: #198754;">
                            <div class="workflow-label">Paso 2: Grupos</div>
                            <a href="{% url 'lista_grupos' t.id %}" 
                               class="btn btn-sm btn-outline-success action-btn-custom" 
                               data-bs-toggle="tooltip" 
                               title="Ver estadÃ­sticas y partidos de cada grupo">
                                ğŸ“Š Grupos ({{ t.numero_grupos }})
                            </a>
                        </div>
                        {% endif %}
                        
                        <!-- Paso 3: Bracket y Partidos -->
                        <div class="workflow-section" style="border-color: #fd7e14;">
                            <div class="workflow-label">Paso 3: Bracket / Partidos</div>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'lista_partidos' t.id %}" 
                                   class="btn btn-outline-warning action-btn-custom" 
                                   data-bs-toggle="tooltip" 
                                   title="Ver todos los partidos y cargar resultados"
                                   style="min-width: 80px;">
                                    ğŸ¾ Partidos
                                </a>
                                <a href="{% url 'bracket_visual' t.id %}" 
                                   class="btn btn-outline-primary action-btn-custom" 
                                   data-bs-toggle="tooltip" 
                                   title="Ver bracket visual de eliminaciÃ³n directa"
                                   style="min-width: 80px;">
                                    ğŸ† Bracket
                                </a>
                            </div>
                        </div>
                    </div>
                </td>
                {% if es_admin %}
                <td>
                    <div class="d-flex flex-column gap-1">
                        <a href="{% url 'editar_torneo' t.id %}" 
                           class="btn btn-sm btn-outline-warning" 
                           data-bs-toggle="tooltip" 
                           title="Editar informaciÃ³n del torneo">
                            âœï¸
                        </a>
                        <a href="{% url 'eliminar_torneo' t.id %}" 
                           class="btn btn-sm btn-outline-danger" 
                           onclick="return confirm('âš ï¸ Â¿Eliminar torneo y todos sus datos?')"
                           data-bs-toggle="tooltip" 
                           title="Eliminar torneo permanentemente">
                            ğŸ—‘ï¸
                        </a>
                    </div>
                </td>
                {% endif %}
            </tr>
            {% empty %}
            <tr><td colspan="{% if es_admin %}7{% else %}6{% endif %}" class="text-center text-muted py-4">
                <div class="py-3">
                    <h5>ğŸ“­ No hay torneos registrados</h5>
                    <p class="text-muted">Crea tu primer torneo para comenzar</p>
                </div>
            </td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% block extra_js %}
<script>
// Filtros de nombre y estado en la tabla de torneos
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar tooltips de Bootstrap
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  const filtroNombre = document.getElementById('filtroNombre');
  const filtroEstado = document.getElementById('filtroEstado');
  const filas = Array.from(document.querySelectorAll('#torneosBody tr'));
  
  function aplicarFiltros() {
    const n = (filtroNombre.value || '').toLowerCase();
    const e = filtroEstado.value || '';
    let visibles = 0;
    filas.forEach(tr => {
      if (!tr.dataset.nombre) return; // Skip empty row
      const okNombre = tr.dataset.nombre.includes(n);
      const okEstado = !e || tr.dataset.estado === e;
      const show = okNombre && okEstado;
      tr.style.display = show ? '' : 'none';
      if (show) visibles++;
    });
  }
  
  filtroNombre.addEventListener('input', aplicarFiltros);
  filtroEstado.addEventListener('change', aplicarFiltros);
});
</script>
{% endblock %}
{% endblock %}